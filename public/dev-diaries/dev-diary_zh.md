# WitNote 开发日记

## v1.2.9: App Store 审核的那些坑与 Intel 芯片的艰难取舍
*2025.12.31*

### 1. 🍎 App Store 审核采坑记：窗口去哪了？

最近 WitNote 在提交 Mac App Store 审核时，收到了这样一条反馈：

> **准则 4 - 设计**
> 
> 我们注意到您的应用用户界面存在一个问题，这导致用户体验低于 App Store 用户的预期。
> 具体来说，我们发现当用户关闭主应用程序窗口时，没有任何菜单项可以重新打开它。

#### 问题复盘
这是一个非常典型的 macOS 应用开发误区，特别是对于像我这样从 Windows 转过来的开发者。

在 Windows 上，点击窗口右上角的 `X` 通常意味着退出程序。但在 macOS 上，点击左上角的红叉只是 **关闭窗口 (Close Window)**，应用程序本身 (Process) 依然在后台运行（Dock 栏图标下方有小黑点）。

审核人员发现的问题是：
1. 点击红叉关闭了 WitNote 主窗口。
2. 程序还在运行。
3. 当他再次点击 Dock 栏上的图标，或者去顶部菜单栏找“窗口”菜单时，发现 **主窗口弹不出来了**。
4. 这给人的感觉就像是应用“死机”了。

#### 解决方案
为了修复这个问题，我们需要在 Electron 的主进程 (`main.ts`) 中处理 `activate` 事件，并确保菜单栏中有“窗口”选项。

**1. 监听 `activate` 事件**
当用户点击 Dock 图标时，macOS 会触发 `activate` 事件。我们需要监听它，并检查当前是否还有窗口存在。如果没有，就新建一个。

```typescript
// electron/main.ts

app.on('activate', () => {
    // macOS: 点击 Dock 图标时重新显示或创建窗口
    if (mainWindow) {
        // 窗口存在但可能被隐藏或最小化
        mainWindow.show()
        mainWindow.focus()
    } else if (BrowserWindow.getAllWindows().length === 0) {
        // 没有任何窗口，创建新窗口
        createWindow()
    }
})
```

**2. 完善“窗口”菜单** 
符合 macOS 规范的应用都应该有一个 "Window" 菜单。我们在菜单模板中添加了 `Show Main Window` 选项。

修复后，无论用户如何关闭窗口，只要点击 Dock 图标或菜单项，WitNote 都会立刻回到眼前。

---

### 2. ❌ 艰难的决定：不再支持 Intel Mac

在 v1.2.9 版本中，我们正式更新了设备支持列表，明确标记 **不再支持 Intel 芯片的 Mac 电脑**。

这是一个基于技术现实的决定，主要原因如下：

#### 底层架构与指令集不兼容
WitNote 的核心卖点是 "完全本地离线 AI"。为了实现这一点，我们集成了 **WebLLM** 和 **Ollama** 等推理引擎。目前的 macOS 本地 AI 生态几乎完全是围绕 **Apple Silicon (M1/M2/M3)** 的 ARM64 架构构建的。

如果在 Intel 芯片 (x86_64) 上强制运行这些针对 ARM64 优化的二进制文件或 Python 环境，不仅需要依赖 Rosetta 2 转译，而且对于高度依赖 AVX 指令集和矩阵运算的 AI 推理程序，转译往往会出现严重的兼容性问题甚至直接崩溃。

#### 缺失核心硬件加速 (NPU/Metal)
Apple Silicon 芯片之所以能流畅运行本地大模型，核心在于其 **统一内存架构 (Unified Memory)** 和专用的 **NPU (神经网络引擎)**。

WitNote 使用的推理引擎主要是针对 Apple Silicon 的 GPU/Metal 进行了优化。Intel Mac 使用的是独立显卡或集成显卡，内存带宽远低于 M 系列芯片。在 Intel Mac 上运行量化模型：
- **速度极慢**：生成一个字可能需要好几秒。
- **发热巨大**：风扇会狂转，完全背离了 WitNote "轻盈、静谧" 的初衷。

#### 开发者的取舍
为了保证绝大多数用户（Apple Silicon 用户）的体验，并控制安装包体积，我们选择只针对当前主流的 M 芯片架构进行构建与优化。

对于 Intel Mac 用户，我们深表歉意。如果您的设备不支持，可以使用 WitNote 的 **Cloud API** 模式，或者考虑升级到 Apple Silicon 设备以体验完全体的本地 AI。

---

## v1.2.4: 构建采坑与架构取舍

### 前言

发布 v1.2.4 版本的过程充满了挑战与取舍。作为一个跨平台应用（macOS & Windows），在追求原生体验与高性能的同时，不可避免地会遇到平台特有的限制。本篇日记记录了在构建过程中遇到的两个主要“坑”以及相应的架构决策，希望能对同样在折腾 Electron 开发的朋友们有所启发。

### 1. 🍎 macOS 构建：Security-Scoped Bookmarks 的那些事

在为 Mac App Store (MAS) 构建版本时，最大的挑战来源于 Apple 严格的沙盒（Sandbox）机制。

#### 问题描述
为了符合 MAS 的上架要求，应用必须开启沙盒环境。然而，沙盒环境限制了应用对文件系统的任意访问。即使用户通过 `dialog.showOpenDialog` 明确选择了某个文件夹，应用也只能在当次运行中拥有访问权限。一旦应用重启，权限就会丢失，导致用户无法再次打开之前添加的文件夹。

#### 解决方案
为了解决这个问题，必须实现 **Security-Scoped Bookmarks**。

1.  **获取权限时保存 Bookmark**：当用户选择文件夹时，通过 Electron 的 API 获取该路径的 `bookmark`（由 macOS 系统生成的一串加密数据）。
2.  **持久化存储**：将这个 `bookmark` 字符串存储在本地数据库（如 LowDB）中。
3.  **重启后恢复权限**：应用启动时，读取存储的 `bookmark`，并调用 `app.startAccessingSecurityScopedResource` 来重新激活访问权限。

这个机制确保了用户在重启应用后，依然可以流畅地访问他们的笔记库，既满足了安全性，又保证了用户体验。在 v1.2.4 中，我们终于彻底修复了 MAS 版本下的文件夹权限问题。

### 2. 🪟 Windows 构建：忍痛割爱 WebLLM

相对于 macOS 的权限斗争，Windows 版本的挑战则更多在于性能与架构的选择。

#### 架构决策
在 v1.2.4 的 Windows 版本中，我们做出了一个艰难的决定：**移除内置的 WebLLM 引擎支持**。

#### 原因分析
1.  **性能瓶颈**：WebLLM 依赖于 WebGPU 技术在浏览器环境中运行大模型。虽然在 macOS（尤其是 Apple Silicon 芯片）上表现尚可，但在 Windows 平台上，由于硬件配置千差万别，驱动兼容性复杂，导致 WebLLM 的加载速度慢、推理延迟高，甚至在很多中低端机器上直接崩溃。
2.  **用户体验**：为了维持一个不稳定的功能而牺牲整体应用的流畅度和稳定性是不划算的。用户期待的是一个“开箱即用”且响应迅速的工具，而不是一个需要漫长等待加载的试验品。
3.  **替代方案**：我们强烈推荐 Windows 用户使用 **Ollama**。作为一个独立的本地推理引擎，Ollama 在 Windows 上运行非常稳定且高效。不仅支持的模型更多（如 Llama 3, Qwen 2.5 等），而且资源占用控制得更好。

#### 结论
虽然少了一个“内置引擎”的卖点，但通过引导用户使用架构更成熟的 Ollama，实际上提升了最终的生产力体验。架构选择往往就是这样，没有绝对的完美，只有在特定场景下最合适的权衡。

---
*以上不仅仅是技术记录，也是智简 WitNote 走向更成熟、更稳定的一步。感谢每一位用户的包容与反馈。*
